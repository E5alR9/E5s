local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

------------------------------------------
-- 1. 全圖高亮切換與強制鎖定
------------------------------------------
if _G.OriginalSettings == nil then
    _G.OriginalSettings = {
        Ambient = Lighting.Ambient,
        OutdoorAmbient = Lighting.OutdoorAmbient,
        Brightness = Lighting.Brightness,
        ClockTime = Lighting.ClockTime,
        FogEnd = Lighting.FogEnd,
        GlobalShadows = Lighting.GlobalShadows
    }
end

if _G.NightVisionEnabled == nil then _G.NightVisionEnabled = false end
_G.NightVisionEnabled = not _G.NightVisionEnabled

-- 鎖定亮度函數
local function LockLighting()
    if _G.NightVisionEnabled then
        Lighting.Ambient = Color3.fromRGB(255, 255, 255)
        Lighting.OutdoorAmbient = Color3.fromRGB(255, 255, 255)
        Lighting.Brightness = 3
        Lighting.ClockTime = 14
        Lighting.FogEnd = 100000
        Lighting.GlobalShadows = false
    end
end

-- 建立一個循環，如果遊戲試圖改暗，就立刻改回來
if _G.LightingLoop then _G.LightingLoop:Disconnect() end
_G.LightingLoop = RunService.RenderStepped:Connect(function()
    if _G.NightVisionEnabled then
        LockLighting()
    end
end)

if _G.NightVisionEnabled then
    print("L: ON")
else
    -- 關閉時還原一次並停止鎖定
    local orig = _G.OriginalSettings
    Lighting.Ambient = orig.Ambient
    Lighting.OutdoorAmbient = orig.OutdoorAmbient
    Lighting.Brightness = orig.Brightness
    Lighting.ClockTime = orig.ClockTime
    Lighting.FogEnd = orig.FogEnd
    Lighting.GlobalShadows = orig.GlobalShadows
    print("L: OFF")
end

------------------------------------------
-- 2. 物理控制 (R鍵加速 & 空格升空)
------------------------------------------
if _G.MainLoop then _G.MainLoop:Disconnect() end

local MOVE_SPEED = 1.7 
local UP_SPEED = 0.1   

local isPressingR = false
local isPressingSpace = false

UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.R then
        isPressingR = true
    elseif input.KeyCode == Enum.KeyCode.Space then
        isPressingSpace = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.R then
        isPressingR = false
    elseif input.KeyCode == Enum.KeyCode.Space then
        isPressingSpace = false
    end
end)

_G.MainLoop = RunService.Stepped:Connect(function()
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    
    if hrp and hum then
        if isPressingR and hum.MoveDirection.Magnitude > 0 then
            hrp.CFrame = hrp.CFrame + (hum.MoveDirection * MOVE_SPEED)
        end
        
        if isPressingSpace then
            hrp.Velocity = Vector3.new(hrp.Velocity.X, 0, hrp.Velocity.Z) 
            hrp.CFrame = hrp.CFrame * CFrame.new(0, UP_SPEED, 0)
        end
    end
end)
