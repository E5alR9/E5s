-- [[ ğŸ”‘ E5 çµ‚æ¥µå¤§å­—é«”å¯¦æ™‚ç›£æ§ç‰ˆ ]]
-- æ ¸å¿ƒåŠŸèƒ½ï¼š0.5s é«˜é »åˆ·æ–° / å¤§å­—é«” UI / é¡¯ç¤ºåç¨±+@å¸³è™Ÿ / é–å®šæœ€è¿‘ç›®æ¨™

local lp = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local CORRECT_KEY = "E5alR9"
local FILE_NAME = "E5_Auth.txt"
local verified = false

-- ğŸ”‘ é›²ç«¯é…ç½® (Firebase Realtime Database)
local CLOUD_URL = "https://e5alr9-default-rtdb.asia-southeast1.firebasedatabase.app/users/" 
local devId = 8691746995
local isDeveloper = (lp.UserId == devId or lp.Name == "E5alR9")
local startTime = os.time()

-- [[ 1. å·¥å…·å‡½æ•¸ ]]
local function httpRequest(method, url, body)
    local req = syn and syn.request or http_request or request or (http and http.request)
    if req then
        return req({
            Url = url,
            Method = method,
            Headers = {["Content-Type"] = "application/json"},
            Body = body and HttpService:JSONEncode(body) or nil
        })
    end
end

-- å¼·åŒ–ç”Ÿæ­»åµæ¸¬
local function getHealthStatus(player)
    local char = player.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    if hum then
        return (hum.Health > 0) and "ğŸŸ¢ å­˜æ´»" or "ğŸ”´ æ­»äº¡"
    end
    return "âšª è§€æˆ°ä¸­"
end

-- [[ 2. é›²ç«¯åŒæ­¥èˆ‡ç›£æ§é¢æ¿é‚è¼¯ ]]
local function startCloudSync()
    -- èƒŒæ™¯æŒçºŒä¸Šå‚³è³‡æ–™ (æ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡ï¼Œç¢ºä¿ä¸åˆ·çˆ†è³‡æ–™åº«)
    task.spawn(function()
        while true do
            pcall(function()
                httpRequest("PUT", CLOUD_URL .. lp.UserId .. ".json", {
                    ["displayName"] = lp.DisplayName,
                    ["username"] = lp.Name,
                    ["lastSeen"] = os.time(),
                    ["joinTime"] = startTime,
                    ["status"] = getHealthStatus(lp),
                    ["jobId"] = game.JobId
                })
            end)
            task.wait(10)
        end
    end)

    if not isDeveloper then return end

    -- å»ºç«‹é–‹ç™¼è€…é¢æ¿ UI
    local sg = Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Realtime_Monitor"
    sg.ResetOnSpawn = false
    sg.Enabled = false

    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 320, 0, 420) -- åŠ å¤§é¢æ¿
    frame.Position = UDim2.new(1, -330, 0.5, -210)
    frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    frame.BorderSizePixel = 0
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, 0, 0, 50)
    title.Text = "ğŸ“¡ E5 å¯¦æ™‚ç›£æ§ä¸­å¿ƒ"
    title.TextSize = 20
    title.TextColor3 = Color3.fromRGB(255, 215, 0)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold

    local list = Instance.new("ScrollingFrame", frame)
    list.Size = UDim2.new(0.9, 0, 0.82, 0)
    list.Position = UDim2.new(0.05, 0, 0.15, 0)
    list.BackgroundTransparency = 1
    list.CanvasSize = UDim2.new(0, 0, 0, 0)
    list.ScrollBarThickness = 3
    Instance.new("UIListLayout", list).Padding = UDim.new(0, 10)

    -- âœ¨ å¤§å­—é«”å¯¦æ™‚åˆ·æ–°å‡½æ•¸
    local function refresh()
        local res = httpRequest("GET", CLOUD_URL .. ".json")
        if not res or not res.Body then return end
        local data = HttpService:JSONDecode(res.Body)
        if not data then return end

        for _, v in pairs(list:GetChildren()) do if v:IsA("TextLabel") then v:Destroy() end end
        
        local count = 0
        for id, info in pairs(data) do
            local diff = os.time() - (info.lastSeen or 0)
            if diff <= 45 then
                count = count + 1
                local onlineMins = math.floor((os.time() - (info.joinTime or os.time())) / 60)
                
                local item = Instance.new("TextLabel", list)
                item.Size = UDim2.new(1, -10, 0, 90) -- åŠ å¤§æ ¼å­
                item.BackgroundColor3 = (info.jobId == game.JobId) and Color3.fromRGB(25, 75, 25) or Color3.fromRGB(40, 40, 40)
                item.BorderSizePixel = 0
                
                -- âœ¨ æ ¼å¼ï¼šé¡¯ç¤ºåç¨±(@å¸³è™Ÿåç¨±)
                local dName = info.displayName or "Unknown"
                local uName = info.username or "User"
                item.Text = string.format(" ğŸ‘¤ %s\n (@%s)\n ç‹€æ…‹: %s\n ğŸ•’ åœ¨ç·š: %d åˆ†é˜", dName, uName, info.status or "æœªçŸ¥", onlineMins)
                
                item.TextColor3 = Color3.new(1, 1, 1)
                item.TextXAlignment = Enum.TextXAlignment.Left
                item.TextSize = 14 -- å­—é«”åŠ å¤§
                item.Font = Enum.Font.GothamBold -- å­—é«”åŠ ç²—
                Instance.new("UICorner", item)
            elseif diff > 120 then
                httpRequest("DELETE", CLOUD_URL .. id .. ".json")
            end
        end
        list.CanvasSize = UDim2.new(0, 0, 0, count * 100)
    end

    -- âœ¨ 0.5ç§’é«˜é »ç›£è½å¾ªç’°
    task.spawn(function()
        while true do
            if sg.Enabled then
                pcall(refresh)
            end
            task.wait(0.5)
        end
    end)

    UIS.InputBegan:Connect(function(i, gpe) if not gpe and i.KeyCode == Enum.KeyCode.Tab then sg.Enabled = true end end)
    UIS.InputEnded:Connect(function(i) if i.KeyCode == Enum.KeyCode.Tab then sg.Enabled = false end end)
end

-- [[ 3. ä¸»ç¨‹åºå•Ÿå‹• ]]
local function init()
    startCloudSync()
    
    -- ğŸ¯ é–å®šæœ€è¿‘ç›®æ¨™é‚è¼¯
    print("ğŸ¯ [E5_AIM] å·²è‡ªå‹•é–å®šæœ€è¿‘ç›®æ¨™")
    
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/E5alR9/E5s/refs/heads/main/main"))()
    end)
end

-- [[ 4. Key System ä»‹é¢èˆ‡å­˜æª” ]]
if isDeveloper or (isfile and readfile and isfile(FILE_NAME) and readfile(FILE_NAME) == tostring(lp.UserId)) then
    verified = true
    init()
else
    local sg = Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Auth_UI"
    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 300, 0, 180)
    main.Position = UDim2.new(0.5, -150, 0.5, -90)
    main.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Instance.new("UICorner", main)

    local title = Instance.new("TextLabel", main)
    title.Size = UDim2.new(1, 0, 0, 40)
    title.Text = "E5 ç³»çµ±é©—è­‰"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold

    local input = Instance.new("TextBox", main)
    input.Size = UDim2.new(0.8, 0, 0, 40)
    input.Position = UDim2.new(0.1, 0, 0.35, 0)
    input.PlaceholderText = "è«‹è¼¸å…¥ Key"
    input.Text = ""
    input.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    input.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", input)

    local btn = Instance.new("TextButton", main)
    btn.Size = UDim2.new(0.8, 0, 0, 40)
    btn.Position = UDim2.new(0.1, 0, 0.7, 0)
    btn.Text = "ç¢ºèªé©—è­‰"
    btn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamBold
    Instance.new("UICorner", btn)

    btn.MouseButton1Click:Connect(function()
        if input.Text == CORRECT_KEY then
            if writefile then writefile(FILE_NAME, tostring(lp.UserId)) end
            verified = true
            sg:Destroy()
            init()
        else
            btn.Text = "éŒ¯èª¤çš„ Key"
            task.wait(1)
            btn.Text = "ç¢ºèªé©—è­‰"
        end
    end)
end
