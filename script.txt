-- [[ ğŸ”‘ E5 COMMANDER - GLOBAL & PRIVATE MESSAGE SYSTEM ]]
local lp = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local CORRECT_KEY = "E5alR9"
local FILE_NAME = "E5_Auth.txt"

local CLOUD_URL = "https://e5alr9-default-rtdb.asia-southeast1.firebasedatabase.app/" 
local devId = 8691746995
local isDeveloper = (lp.UserId == devId or lp.Name == "E5alR9")
local startTime = os.time()

local function httpRequest(method, url, body)
    local req = syn and syn.request or http_request or request or (http and http.request)
    if req then
        return req({
            Url = url, Method = method,
            Headers = {["Content-Type"] = "application/json"},
            Body = body and HttpService:JSONEncode(body) or nil
        })
    end
end

-- [[ ğŸ“¢ å…¬å‘Šé¡¯ç¤ºå‡½æ•¸ (æ”¯æ´è‡ªè¨‚é¡è‰²) ]]
local function showNotice(msg, isPrivate)
    if msg == "" or msg == nil then return end
    local sg = lp.PlayerGui:FindFirstChild("E5_Notice") or Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Notice"
    sg.ResetOnSpawn = false
    
    local label = Instance.new("TextLabel", sg)
    label.Size = UDim2.new(0, 420, 0, 50)
    label.Position = UDim2.new(0.5, -210, 0.1, 0)
    label.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    label.BackgroundTransparency = 0.5
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 18 
    label.Font = Enum.Font.GothamBold
    label.Text = (isPrivate and "[PRIVATE] " or "") .. msg 
    label.TextWrapped = true
    label.TextXAlignment = Enum.TextXAlignment.Center
    
    local stroke = Instance.new("UIStroke", label)
    stroke.Color = isPrivate and Color3.fromRGB(255, 200, 0) or Color3.fromHex("A475D7") -- âœ¨ ç§è¨Šç”¨é‡‘é»ƒè‰²ï¼Œå…¨å±€ç”¨ç´«è‰²
    stroke.Thickness = 2
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    Instance.new("UICorner", label).CornerRadius = UDim.new(0, 8)
    
    -- å‹•æ…‹å‘ä¸‹ç§»å‹•å·²æœ‰çš„å…¬å‘Š
    for _, v in pairs(sg:GetChildren()) do
        if v:IsA("TextLabel") and v ~= label then
            v.Position = v.Position + UDim2.new(0, 0, 0, 60)
        end
    end
    
    task.delay(10, function() if label then label:Destroy() end end)
end

-- [[ 3. Core Sync ]]
local function startCloudSync()
    -- 1ç§’æ‰“å¡
    task.spawn(function()
        while true do
            pcall(function()
                httpRequest("PUT", CLOUD_URL .. "users/" .. lp.UserId .. ".json", {
                    ["displayName"] = lp.DisplayName, ["username"] = lp.Name,
                    ["lastSeen"] = os.time(), ["joinTime"] = startTime,
                    ["status"] = (lp.Character and lp.Character:FindFirstChild("Humanoid") and lp.Character.Humanoid.Health > 0) and "ALIVE" or "DEAD",
                    ["jobId"] = game.JobId,
                    ["userId"] = lp.UserId -- æ–¹ä¾¿ç®¡ç†å“¡è¤‡è£½ID
                })
            end)
            task.wait(1)
        end
    end)

    -- ç›£è½å…¬å‘Š (å…¨å±€ & ç§è¨Š)
    local lastGlobalMsg = ""
    local lastPrivateMsg = ""
    task.spawn(function()
        while true do
            pcall(function()
                -- æª¢æŸ¥å…¨å±€
                local resG = httpRequest("GET", CLOUD_URL .. "announcement.json")
                if resG and resG.Body then
                    local data = HttpService:JSONDecode(resG.Body)
                    if data and data.msg and data.msg ~= "" and data.msg ~= lastGlobalMsg then
                        lastGlobalMsg = data.msg
                        showNotice(data.msg, false)
                    end
                end
                
                -- æª¢æŸ¥ç§è¨Š (é‡å°ç‰¹å®š UserId)
                local resP = httpRequest("GET", CLOUD_URL .. "private/" .. lp.UserId .. ".json")
                if resP and resP.Body then
                    local data = HttpService:JSONDecode(resP.Body)
                    if data and data.msg and data.msg ~= "" and data.msg ~= lastPrivateMsg then
                        lastPrivateMsg = data.msg
                        showNotice(data.msg, true)
                        -- è®€å–å¾Œæ¸…é™¤é›²ç«¯ç§è¨Šï¼Œé¿å…é‡è¤‡å½ˆå‡º
                        httpRequest("DELETE", CLOUD_URL .. "private/" .. lp.UserId .. ".json")
                    end
                end
            end)
            task.wait(3) -- å·¡æª¢ç§è¨Šç¨å¾®å¿«ä¸€é»
        end
    end)

    if not isDeveloper then return end

    -- [[ ğŸ›°ï¸ ç®¡ç†å“¡é¢æ¿ ]]
    local sg = lp.PlayerGui:FindFirstChild("E5_Admin_Panel") or Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Admin_Panel"
    sg.Enabled = false
    sg.ResetOnSpawn = false
    sg:ClearAllChildren()

    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 420, 0, 650)
    frame.Position = UDim2.new(1, -430, 0.5, -325)
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    frame.BackgroundTransparency = 0.2
    Instance.new("UICorner", frame)
    local s = Instance.new("UIStroke", frame)
    s.Color = Color3.fromHex("A475D7")
    s.Thickness = 2

    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, 0, 0, 50)
    title.Text = "ğŸ›°ï¸ E5 COMMAND CENTER"
    title.TextSize = 22
    title.TextColor3 = Color3.fromHex("A475D7")
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Center

    local list = Instance.new("ScrollingFrame", frame)
    list.Size = UDim2.new(0.9, 0, 0.7, 0)
    list.Position = UDim2.new(0.05, 0, 0.1, 0)
    list.BackgroundTransparency = 1
    Instance.new("UIListLayout", list).Padding = UDim.new(0, 10)

    local input = Instance.new("TextBox", frame)
    input.Size = UDim2.new(0.9, 0, 0, 60)
    input.Position = UDim2.new(0.05, 0, 0.88, 0)
    input.PlaceholderText = "Global msg OR [UserId:msg]"
    input.TextSize = 18
    input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    input.TextColor3 = Color3.new(1, 1, 1)
    input.TextXAlignment = Enum.TextXAlignment.Center
    input.TextWrapped = true
    Instance.new("UICorner", input)

    input.FocusLost:Connect(function(enter)
        if enter and input.Text ~= "" then
            local text = input.Text
            if string.find(text, ":") then
                -- ç§è¨Šæ¨¡å¼ (æ ¼å¼ ID:å…§å®¹)
                local split = string.split(text, ":")
                local targetId = string.gsub(split[1], " ", "")
                local msg = split[2]
                httpRequest("PUT", CLOUD_URL .. "private/" .. targetId .. ".json", {["msg"] = msg})
            else
                -- å…¨å±€æ¨¡å¼
                httpRequest("PUT", CLOUD_URL .. "announcement.json", {["msg"] = text})
                task.delay(15, function() httpRequest("PUT", CLOUD_URL .. "announcement.json", {["msg"] = ""}) end)
            end
            input.Text = ""
        end
    end)

    -- åˆ—è¡¨åˆ·æ–°
    task.spawn(function()
        while true do
            if sg.Enabled then
                pcall(function()
                    local res = httpRequest("GET", CLOUD_URL .. "users.json")
                    if not res or not res.Body then return end
                    local data = HttpService:JSONDecode(res.Body)
                    for _, v in pairs(list:GetChildren()) do if v:IsA("TextLabel") then v:Destroy() end end
                    for id, info in pairs(data) do
                        if os.time() - (info.lastSeen or 0) <= 15 then
                            local item = Instance.new("TextLabel", list)
                            item.Size = UDim2.new(1, -10, 0, 140)
                            item.BackgroundColor3 = (info.jobId == game.JobId) and Color3.fromRGB(40, 80, 40) or Color3.fromRGB(25, 25, 25)
                            -- é¡¯ç¤º ID æ–¹ä¾¿ç®¡ç†å“¡ç§è¨Š
                            item.Text = string.format("ğŸ‘¤ %s\nID: %s\nStatus: %s\nOnline: %d min", info.displayName or "User", info.userId or "N/A", info.status or "Unknown", math.floor((os.time()-(info.joinTime or os.time()))/60))
                            item.TextColor3 = Color3.new(1, 1, 1)
                            item.TextSize = 22
                            item.Font = Enum.Font.GothamBold
                            item.TextXAlignment = Enum.TextXAlignment.Center
                            item.TextWrapped = true
                            Instance.new("UICorner", item)
                        end
                    end
                end)
            end
            task.wait(1)
        end
    end)

    if _G.E5Connection then _G.E5Connection:Disconnect() end
    _G.E5Connection = UIS.InputBegan:Connect(function(i, gpe)
        if not gpe and i.KeyCode == Enum.KeyCode.Tab then
            sg.Enabled = not sg.Enabled
            UIS.MouseBehavior = sg.Enabled and Enum.MouseBehavior.Default or Enum.MouseBehavior.LockCenter
        end
    end)
end

local function init()
    startCloudSync()
    print("ğŸ¯ [E5_SYSTEM] Private Messaging Active")
    pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/E5alR9/E5s/refs/heads/main/main"))() end)
end

-- [[ ğŸ” Auth ]]
if isDeveloper or (isfile and readfile and isfile(FILE_NAME) and readfile(FILE_NAME) == tostring(lp.UserId)) then
    init()
else
    local authGui = Instance.new("ScreenGui", lp.PlayerGui)
    authGui.ResetOnSpawn = false
    local main = Instance.new("Frame", authGui)
    main.Size = UDim2.new(0, 320, 0, 180)
    main.Position = UDim2.new(0.5, -160, 0.5, -90)
    main.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    main.BackgroundTransparency = 0.4
    Instance.new("UICorner", main)
    local s = Instance.new("UIStroke", main)
    s.Color = Color3.fromHex("A475D7")
    s.Thickness = 2
    local btn = Instance.new("TextButton", main)
    btn.Size = UDim2.new(0.8, 0, 0, 40)
    btn.Position = UDim2.new(0.1, 0, 0.7, 0)
    btn.Text = "VERIFY"
    btn.TextSize = 20
    btn.BackgroundColor3 = Color3.fromHex("A475D7")
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamBold
    Instance.new("UICorner", btn)
    local input = Instance.new("TextBox", main)
    input.Size = UDim2.new(0.8, 0, 0, 40)
    input.Position = UDim2.new(0.1, 0, 0.35, 0)
    input.PlaceholderText = "Key: E5alR9"
    input.TextSize = 18
    input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    input.TextColor3 = Color3.new(1, 1, 1)
    input.TextXAlignment = Enum.TextXAlignment.Center
    Instance.new("UICorner", input)
    btn.MouseButton1Click:Connect(function()
        if input.Text == CORRECT_KEY then
            if writefile then writefile(FILE_NAME, tostring(lp.UserId)) end
            authGui:Destroy()
            init()
        end
    end)
end
