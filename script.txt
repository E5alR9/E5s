-- [[ üîë E5 COMMANDER - 10-WAY STABLE (INTEGRATED + TELEPORT) ]]
local lp = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService") -- ÊúçÂãôÁç≤Âèñ
local CORRECT_KEY = "E5alR9"
local FILE_NAME = "E5_Auth.txt"

-- [[ üåê ÂçÅË∑ØÂàÜÊµÅ URL ÈÖçÁΩÆ ]]
local DB_LIST = {
    [0] = "https://e5alr90-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [1] = "https://e5alr9-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [2] = "https://e5alr92-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [3] = "https://e5alr93-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [4] = "https://e5alr94-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [5] = "https://e5alr95-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [6] = "https://e5alr96-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [7] = "https://e5alr97-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [8] = "https://e5alr98-default-rtdb.asia-southeast1.firebasedatabase.app/",
    [9] = "https://e5alr99-default-rtdb.asia-southeast1.firebasedatabase.app/"
}

-- [ÂàÜÊµÅË®àÁÆó]
local function getTargetDB(uid)
    return uid % 10
end

local myDBIndex = getTargetDB(lp.UserId)
local myDBURL = DB_LIST[myDBIndex]

local devId = 8691746995
local isDeveloper = (lp.UserId == devId or lp.Name == "E5alR9")
local finalJoinTime = os.time() 

-- [[ üåê HTTP Â∑•ÂÖ∑ ]]
local function httpRequest(method, url, body)
    local req = syn and syn.request or http_request or request or (http and http.request)
    if req then
        local success, result = pcall(function()
            return req({
                Url = url, Method = method,
                Headers = {["Content-Type"] = "application/json"},
                Body = body and HttpService:JSONEncode(body) or nil
            })
        end)
        return success and result or nil
    end
end

-- [[ üì¢ Notice Á≥ªÁµ± ]]
local function showNotice(msg, isPrivate)
    if not msg or msg == "" then return end
    local sg = lp.PlayerGui:FindFirstChild("E5_Notice") or Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Notice"
    sg.ResetOnSpawn = false
    local container = Instance.new("Frame", sg)
    container.Size = UDim2.new(0, 0, 0, 50)
    container.Position = UDim2.new(0.5, 0, 0.1, 0)
    container.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    container.BackgroundTransparency = 0.5
    container.ClipsDescendants = true
    Instance.new("UICorner", container).CornerRadius = UDim.new(0, 8)
    local frameStroke = Instance.new("UIStroke", container)
    frameStroke.Color = isPrivate and Color3.fromRGB(255, 200, 0) or Color3.fromHex("A475D7")
    frameStroke.Thickness = 2
    frameStroke.Transparency = 1
    local label = Instance.new("TextLabel", container)
    label.Size = UDim2.new(0, 400, 1, 0)
    label.Position = UDim2.new(0.5, -200, 0, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 18 
    label.Font = Enum.Font.GothamBold
    label.Text = tostring(msg)
    label.TextWrapped = true
    label.TextTransparency = 1
    for _, v in pairs(sg:GetChildren()) do
        if v:IsA("Frame") and v ~= container then
            v:TweenPosition(v.Position + UDim2.new(0, 0, 0, 60), "Out", "Quad", 0.3, true)
        end
    end
    local expandTween = TweenService:Create(container, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, 420, 0, 50), Position = UDim2.new(0.5, -210, 0.1, 0)
    })
    expandTween:Play()
    expandTween.Completed:Connect(function()
        TweenService:Create(label, TweenInfo.new(0.3), {TextTransparency = 0}):Play()
        TweenService:Create(frameStroke, TweenInfo.new(0.3), {Transparency = 0}):Play()
    end)
    task.delay(8, function()
        local fade = TweenService:Create(label, TweenInfo.new(0.5), {TextTransparency = 1})
        fade:Play()
        fade.Completed:Connect(function()
            local shrink = TweenService:Create(container, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {
                Size = UDim2.new(0, 0, 0, 50), Position = UDim2.new(0.5, 0, container.Position.Y.Scale, container.Position.Y.Offset)
            })
            shrink:Play()
            shrink.Completed:Connect(function() container:Destroy() end)
        end)
    end)
end

-- [[ üõ∞Ô∏è Admin Panel ]]
local function buildAdminPanel()
    local sg = lp.PlayerGui:FindFirstChild("E5_Admin_Panel") or Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Admin_Panel"
    sg.Enabled = false
    sg.ResetOnSpawn = false
    sg:ClearAllChildren()

    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 420, 0, 650)
    frame.Position = UDim2.new(1, -430, 0.5, -325)
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    frame.BackgroundTransparency = 0.3
    Instance.new("UICorner", frame)
    Instance.new("UIStroke", frame).Color = Color3.fromHex("A475D7")

    local list = Instance.new("ScrollingFrame", frame)
    list.Size = UDim2.new(0.9, 0, 0.78, 0)
    list.Position = UDim2.new(0.05, 0, 0.05, 0)
    list.BackgroundTransparency = 1
    list.CanvasSize = UDim2.new(0, 0, 0, 0)
    list.AutomaticCanvasSize = Enum.AutomaticSize.Y
    list.ScrollBarThickness = 2
    Instance.new("UIListLayout", list).Padding = UDim.new(0, 10)

    local input = Instance.new("TextBox", frame)
    input.Size = UDim2.new(0.9, 0, 0, 60)
    input.Position = UDim2.new(0.05, 0, 0.88, 0)
    input.PlaceholderText = "[ID:MSG] Êàñ Áõ¥Êé•ÂÖ¨Âëä"
    input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    input.TextColor3 = Color3.new(1, 1, 1)
    input.TextSize = 18
    Instance.new("UICorner", input)

    input.FocusLost:Connect(function(enter)
        if enter and input.Text ~= "" then
            local text = input.Text
            for i = 0, 9 do 
                if string.find(text, ":") then
                    local split = string.split(text, ":")
                    httpRequest("PUT", DB_LIST[i] .. "private/" .. string.gsub(split[1], " ", "") .. ".json", {["msg"] = split[2]})
                else
                    httpRequest("PUT", DB_LIST[i] .. "announcement.json", {["msg"] = text})
                    task.delay(15, function() httpRequest("PUT", DB_LIST[i] .. "announcement.json", {["msg"] = ""}) end)
                end
            end
            input.Text = ""
        end
    end)

    task.spawn(function()
        while true do
            if sg.Enabled then
                local allUserData = {}
                for i = 0, 9 do 
                    pcall(function()
                        local res = httpRequest("GET", DB_LIST[i] .. "users.json")
                        if res and res.Body then
                            local data = HttpService:JSONDecode(res.Body)
                            for id, info in pairs(data) do 
                                local uid = tonumber(id) or tonumber(info.userId)
                                if uid and getTargetDB(uid) ~= i then
                                    httpRequest("DELETE", DB_LIST[i] .. "users/" .. id .. ".json")
                                else
                                    allUserData[id] = info 
                                end
                            end
                        end
                    end)
                end
                
                for _, v in pairs(list:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
                for id, info in pairs(allUserData) do
                    local currentTime = os.time()
                    local lastSeen = tonumber(info.lastSeen) or 0
                    if currentTime - lastSeen <= 30 then
                        local item = Instance.new("TextButton", list)
                        item.Size = UDim2.new(1, 0, 0, 140) 
                        item.BackgroundColor3 = (info.jobId == game.JobId) and Color3.fromHex("4A306D") or Color3.fromRGB(35, 35, 35)
                        item.BackgroundTransparency = 0.2
                        Instance.new("UICorner", item).CornerRadius = UDim.new(0, 6)
                        local join = tonumber(info.joinTime) or currentTime
                        local diff = math.max(0, currentTime - join)
                        local d, h, m, s = math.floor(diff/86400), math.floor((diff%86400)/3600), math.floor((diff%3600)/60), math.floor(diff%60)
                        item.Text = string.format("üë§ %s\n(@%s)\nID: %s\nStatus: %s\nOnline: %dd %dh %dm %ds", info.displayName or "N/A", info.username or "N/A", info.userId or "N/A", info.status or "ALIVE", d, h, m, s)
                        item.TextColor3 = Color3.new(1, 1, 1)
                        item.TextSize = 17
                        item.Font = Enum.Font.GothamBold
                        item.TextWrapped = true

                        -- [[ üñ±Ô∏è ÂñÆÊìäË§áË£Ω / ÈõôÊìäËøΩËπ§ ]]
                        local lastClick = 0
                        item.MouseButton1Click:Connect(function()
                            local now = tick()
                            if now - lastClick < 0.35 then
                                if info.jobId and info.jobId ~= "" and info.jobId ~= game.JobId then
                                    showNotice("Ê≠£Âú®ËøΩËπ§Áé©ÂÆ∂...", true)
                                    TeleportService:TeleportToPlaceInstance(game.PlaceId, info.jobId, lp)
                                end
                            else
                                if setclipboard then 
                                    setclipboard(tostring(info.userId) .. ":")
                                    showNotice("Â∑≤Ë§áË£Ω ID: " .. info.userId, false)
                                end
                            end
                            lastClick = now
                        end)
                    end
                end
            end
            task.wait(5)
        end
    end)
end

-- [[ üöÄ ÂïüÂãïËàáÂêåÊ≠• ]]
local function startCloudSync()
    local cloudTime = nil
    for i = 1, 3 do
        local res = httpRequest("GET", myDBURL .. "users/" .. lp.UserId .. "/joinTime.json")
        if res and res.Body and res.Body ~= "null" then
            cloudTime = tonumber(res.Body)
            break
        end
        task.wait(0.5)
    end
    if cloudTime then finalJoinTime = cloudTime else httpRequest("PUT", myDBURL .. "users/" .. lp.UserId .. "/joinTime.json", finalJoinTime) end
    task.spawn(function()
        while true do
            pcall(function()
                httpRequest("PUT", myDBURL .. "users/" .. lp.UserId .. ".json", {
                    ["displayName"] = lp.DisplayName, ["username"] = lp.Name,
                    ["lastSeen"] = os.time(), ["joinTime"] = finalJoinTime,
                    ["status"] = (lp.Character and lp.Character:FindFirstChild("Humanoid") and lp.Character.Humanoid.Health > 0) and "ALIVE" or "DEAD",
                    ["jobId"] = game.JobId, ["userId"] = lp.UserId
                })
            end)
            task.wait(1)
        end
    end)
    task.spawn(function()
        local lastG, lastP = "", ""
        while true do
            pcall(function()
                local resG = httpRequest("GET", myDBURL .. "announcement.json")
                if resG and resG.Body then
                    local data = HttpService:JSONDecode(resG.Body)
                    if data and data.msg and data.msg ~= "" and data.msg ~= lastG then
                        lastG = data.msg; showNotice(data.msg, false)
                    end
                end
                local resP = httpRequest("GET", myDBURL .. "private/" .. lp.UserId .. ".json")
                if resP and resP.Body then
                    local data = HttpService:JSONDecode(resP.Body)
                    if data and data.msg and data.msg ~= "" and data.msg ~= lastP then
                        lastP = data.msg; showNotice(data.msg, true)
                        httpRequest("DELETE", myDBURL .. "private/" .. lp.UserId .. ".json")
                    end
                end
            end)
            task.wait(3)
        end
    end)
end

local function init()
    startCloudSync()
    if isDeveloper then buildAdminPanel() end
    pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/E5alR9/E5s/refs/heads/main/main"))() end)
end

-- [[ üîê Auth ]]
if isDeveloper or (isfile and readfile and isfile(FILE_NAME) and readfile(FILE_NAME) == tostring(lp.UserId)) then
    init()
else
    local authGui = Instance.new("ScreenGui", lp.PlayerGui)
    authGui.ResetOnSpawn = false
    local main = Instance.new("Frame", authGui)
    main.Size = UDim2.new(0, 320, 0, 180)
    main.Position = UDim2.new(0.5, -160, 0.5, -90)
    main.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    main.BackgroundTransparency = 0.5
    Instance.new("UIStroke", main).Color = Color3.fromHex("A475D7")
    Instance.new("UICorner", main)
    local btn = Instance.new("TextButton", main)
    btn.Size = UDim2.new(0, 200, 0, 40)
    btn.Position = UDim2.new(0.5, -100, 0.7, 0)
    btn.Text = "VERIFY"
    btn.BackgroundColor3 = Color3.fromHex("A475D7")
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamBold
    Instance.new("UICorner", btn)
    local input = Instance.new("TextBox", main)
    input.Size = UDim2.new(0, 250, 0, 40)
    input.Position = UDim2.new(0.5, -125, 0.35, 0)
    input.PlaceholderText = "Key: E5alR9"
    input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    input.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", input)
    btn.MouseButton1Click:Connect(function()
        if input.Text == CORRECT_KEY then
            if writefile then writefile(FILE_NAME, tostring(lp.UserId)) end
            authGui:Destroy()
            init()
        end
    end)
end

UIS.InputBegan:Connect(function(i, gpe)
    if not gpe and i.KeyCode == Enum.KeyCode.Tab and lp.PlayerGui:FindFirstChild("E5_Admin_Panel") then
        lp.PlayerGui.E5_Admin_Panel.Enabled = not lp.PlayerGui.E5_Admin_Panel.Enabled
    end
end)

-- [[ üíÄ Âæ©Ê¥ªËá™ÂãïÈóúÈñâÂàóË°® ]]
lp.CharacterAdded:Connect(function()
    local panel = lp.PlayerGui:FindFirstChild("E5_Admin_Panel")
    if panel then
        panel.Enabled = false
    end
end)
