-- [[ ğŸ”‘ E5 æŒ‡æ®å®˜çµ‚æ¥µæ•´åˆç‰ˆ - A475D7 ç´«æ¡†é€æ˜å…¬å‘Š ]]
-- æ“ä½œï¼šTAB åˆ‡æ›é¢æ¿/è§£é–æ»‘é¼  | è‡ªå‹•å­˜æª”é©—è­‰ | 0.5s é«˜é »åˆ·æ–°

local lp = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local CORRECT_KEY = "E5alR9"
local FILE_NAME = "E5_Auth.txt"

-- ğŸ”‘ é›²ç«¯é…ç½®
local CLOUD_URL = "https://e5alr9-default-rtdb.asia-southeast1.firebasedatabase.app/" 
local devId = 8691746995
local isDeveloper = (lp.UserId == devId or lp.Name == "E5alR9")
local startTime = os.time()

-- [[ 1. å·¥å…·å‡½æ•¸ ]]
local function httpRequest(method, url, body)
    local req = syn and syn.request or http_request or request or (http and http.request)
    if req then
        return req({
            Url = url, Method = method,
            Headers = {["Content-Type"] = "application/json"},
            Body = body and HttpService:JSONEncode(body) or nil
        })
    end
end

-- [[ 2. âœ¨ å…¬å‘Šé¡¯ç¤ºç³»çµ± (A475D7 é‚Šæ¡†) ]]
local function showAnnouncement(msg)
    local sg = lp.PlayerGui:FindFirstChild("E5_Notice") or Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Notice"
    sg.ResetOnSpawn = false
    
    local label = sg:FindFirstChild("Msg") or Instance.new("TextLabel", sg)
    label.Name = "Msg"
    label.Size = UDim2.new(0, 420, 0, 50)
    label.Position = UDim2.new(0.5, -210, 0.1, 0)
    label.BackgroundTransparency = 1 -- âœ¨ å…¨é€æ˜èƒŒæ™¯
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 18 -- âœ¨ å­—é«”è¼ƒå°ç²¾ç·»
    label.Font = Enum.Font.GothamBold
    label.Text = msg 
    label.TextWrapped = true
    
    -- âœ¨ A475D7 é¡è‰²é‚Šæ¡†
    local stroke = label:FindFirstChild("Stroke") or Instance.new("UIStroke", label)
    stroke.Name = "Stroke"
    stroke.Color = Color3.fromHex("A475D7") -- âœ¨ ä½¿ç”¨ä½ æŒ‡å®šçš„é¡è‰²
    stroke.Thickness = 2
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    local corner = label:FindFirstChild("Corner") or Instance.new("UICorner", label)
    corner.Name = "Corner"
    corner.CornerRadius = UDim.new(0, 8)
    
    task.delay(10, function() 
        if label then label:Destroy() end 
    end)
end

-- [[ 3. æ ¸å¿ƒç›£æ§èˆ‡ UI é‚è¼¯ ]]
local function startCloudSync()
    -- èƒŒæ™¯åŒæ­¥ç©å®¶è³‡æ–™
    task.spawn(function()
        while true do
            pcall(function()
                httpRequest("PUT", CLOUD_URL .. "users/" .. lp.UserId .. ".json", {
                    ["displayName"] = lp.DisplayName,
                    ["username"] = lp.Name,
                    ["lastSeen"] = os.time(),
                    ["joinTime"] = startTime,
                    ["status"] = (lp.Character and lp.Character:FindFirstChild("Humanoid") and lp.Character.Humanoid.Health > 0) and "ğŸŸ¢ å­˜æ´»" or "ğŸ”´ æ­»äº¡",
                    ["jobId"] = game.JobId
                })
            end)
            task.wait(10)
        end
    end)

    -- ç›£è½é›²ç«¯å…¬å‘Š
    local lastMsg = ""
    task.spawn(function()
        while true do
            pcall(function()
                local res = httpRequest("GET", CLOUD_URL .. "announcement.json")
                if res and res.Body then
                    local data = HttpService:JSONDecode(res.Body)
                    if data and data.msg ~= lastMsg then
                        lastMsg = data.msg
                        showAnnouncement(data.msg)
                    end
                end
            end)
            task.wait(5)
        end
    end)

    if not isDeveloper then return end

    -- é–‹ç™¼è€…ç®¡ç†é¢æ¿
    local sg = Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Admin_Panel"
    sg.ResetOnSpawn = false
    sg.Enabled = false

    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 330, 0, 520)
    frame.Position = UDim2.new(1, -340, 0.5, -260)
    frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Instance.new("UICorner", frame)

    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, 0, 0, 45)
    title.Text = "ğŸ›°ï¸ E5 ç®¡ç†ä¸­å¿ƒ"
    title.TextSize = 18
    title.TextColor3 = Color3.fromHex("A475D7")
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold

    local list = Instance.new("ScrollingFrame", frame)
    list.Size = UDim2.new(0.9, 0, 0.65, 0)
    list.Position = UDim2.new(0.05, 0, 0.12, 0)
    list.BackgroundTransparency = 1
    list.ScrollBarThickness = 2
    Instance.new("UIListLayout", list).Padding = UDim.new(0, 10)

    local input = Instance.new("TextBox", frame)
    input.Size = UDim2.new(0.9, 0, 0, 45)
    input.Position = UDim2.new(0.05, 0, 0.85, 0)
    input.PlaceholderText = "ç™¼é€å…¬å‘Šè‡³æ‰€æœ‰ç©å®¶..."
    input.Text = ""
    input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    input.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", input)

    input.FocusLost:Connect(function(enter)
        if enter and input.Text ~= "" then
            httpRequest("PUT", CLOUD_URL .. "announcement.json", {["msg"] = input.Text})
            input.Text = ""
        end
    end)

    -- å¯¦æ™‚åˆ·æ–°åŠŸèƒ½
    local function refresh()
        local res = httpRequest("GET", CLOUD_URL .. "users.json")
        if not res or not res.Body then return end
        local data = HttpService:JSONDecode(res.Body)
        if not data then return end
        for _, v in pairs(list:GetChildren()) do if v:IsA("TextLabel") then v:Destroy() end end
        local count = 0
        for id, info in pairs(data) do
            if os.time() - (info.lastSeen or 0) <= 45 then
                count = count + 1
                local item = Instance.new("TextLabel", list)
                item.Size = UDim2.new(1, -10, 0, 95)
                item.BackgroundColor3 = (info.jobId == game.JobId) and Color3.fromRGB(25, 60, 25) or Color3.fromRGB(35, 35, 35)
                item.Text = string.format(" ğŸ‘¤ %s(@%s)\n ç‹€æ…‹: %s\n ğŸ•’ åœ¨ç·š: %d åˆ†", info.displayName or "User", info.username or "User", info.status or "æœªçŸ¥", math.floor((os.time()-(info.joinTime or os.time()))/60))
                item.TextColor3 = Color3.new(1, 1, 1)
                item.TextSize = 14
                item.Font = Enum.Font.GothamBold
                item.TextXAlignment = Enum.TextXAlignment.Left
                Instance.new("UICorner", item)
            end
        end
        list.CanvasSize = UDim2.new(0, 0, 0, count * 105)
    end

    task.spawn(function()
        while true do if sg.Enabled then pcall(refresh) end task.wait(0.5) end
    end)

    -- TAB åˆ‡æ›èˆ‡æ»‘é¼ é–å®šé‚è¼¯
    UIS.InputBegan:Connect(function(i, gpe)
        if not gpe and i.KeyCode == Enum.KeyCode.Tab then
            sg.Enabled = not sg.Enabled
            UIS.MouseBehavior = sg.Enabled and Enum.MouseBehavior.Default or Enum.MouseBehavior.LockCenter
        end
    end)
end

-- [[ 4. å•Ÿå‹•èˆ‡è‡ªå‹•å­˜æª” ]]
local function init()
    startCloudSync()
    -- ğŸ”’ è‡ªå‹•åŸ·è¡Œï¼šé–å®šæœ€è¿‘ç›®æ¨™
    print("ğŸ¯ [E5_SYSTEM] å•Ÿå‹•æˆåŠŸ | é–å®šæ¨¡å¼: æœ€è¿‘ç›®æ¨™")
    pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/E5alR9/E5s/refs/heads/main/main"))() end)
end

-- è‡ªå‹•é©—è­‰é‚è¼¯ (å­˜éä¸€æ¬¡å°±ä¸ç”¨å†æ‰“ Key)
if isDeveloper or (isfile and readfile and isfile(FILE_NAME) and readfile(FILE_NAME) == tostring(lp.UserId)) then
    init()
else
    local sg = Instance.new("ScreenGui", lp.PlayerGui)
    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 300, 0, 160)
    main.Position = UDim2.new(0.5, -150, 0.5, -80)
    main.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    Instance.new("UICorner", main)
    local input = Instance.new("TextBox", main)
    input.Size = UDim2.new(0.8, 0, 0, 35)
    input.Position = UDim2.new(0.1, 0, 0.4, 0)
    input.PlaceholderText = "Key: E5alR9"
    input.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    input.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", input)
    local btn = Instance.new("TextButton", main)
    btn.Size = UDim2.new(0.8, 0, 0, 35)
    btn.Position = UDim2.new(0.1, 0, 0.75, 0)
    btn.Text = "VERIFY"
    btn.BackgroundColor3 = Color3.fromHex("A475D7")
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.MouseButton1Click:Connect(function()
        if input.Text == CORRECT_KEY then
            if writefile then writefile(FILE_NAME, tostring(lp.UserId)) end
            sg:Destroy()
            init()
        end
    end)
end
