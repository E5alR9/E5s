-- [[ ğŸ”‘ E5 é›²ç«¯å³æ™‚ç›£æ§ - ä¸‹ç·šè‡ªå‹•æ¸…ç†ç‰ˆ ]]
local lp = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local CORRECT_KEY = "E5alR9"
local FILE_NAME = "E5_Auth.txt"
local verified = false

-- ğŸ”‘ ä½ çš„ Firebase ç¶²å€
local CLOUD_URL = "https://e5alr9-default-rtdb.asia-southeast1.firebasedatabase.app/users/" 

-- ğŸ”‘ é–‹ç™¼è€…èº«åˆ†
local devId = 8691746995
local isDeveloper = (lp.UserId == devId or lp.Name == "E5alR9")

-- [[ 1. é›²ç«¯å·¥å…·å‡½æ•¸ ]]
local function request(method, url, body)
    local req = syn and syn.request or http_request or request or (http and http.request)
    if req then
        return req({
            Url = url,
            Method = method,
            Headers = {["Content-Type"] = "application/json"},
            Body = body and HttpService:JSONEncode(body) or nil
        })
    end
end

-- ä¸Šå‚³åœ¨ç·šç‹€æ…‹
local function heartbeat()
    pcall(function()
        request("PUT", CLOUD_URL .. lp.UserId .. ".json", {
            ["name"] = lp.Name,
            ["lastSeen"] = os.time(), -- è¨˜éŒ„ç›®å‰æ™‚é–“
            ["jobId"] = game.JobId
        })
    end)
end

-- åˆªé™¤éæœŸè³‡æ–™ (æ¸…ç†ä¸‹ç·šå¤ªä¹…çš„äºº)
local function cleanOldData(data)
    for id, info in pairs(data) do
        if os.time() - (info.lastSeen or 0) > 60 then -- è¶…é 60 ç§’æ²’å‹•éœå°±åˆªé™¤
            pcall(function()
                request("DELETE", CLOUD_URL .. id .. ".json")
            end)
        end
    end
end

-- [[ 2. ç›£æ§ UI ]]
local function startMonitor()
    -- æ‰€æœ‰äººï¼šæŒçºŒç™¼é€å¿ƒè·³åŒ… (æ¯ 15 ç§’)
    task.spawn(function()
        while true do
            heartbeat()
            task.wait(15)
        end
    end)

    if not isDeveloper then return end

    local sg = Instance.new("ScreenGui", lp.PlayerGui)
    sg.Name = "E5_Live_Monitor"
    sg.Enabled = false
    sg.ResetOnSpawn = false

    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 240, 0, 320)
    frame.Position = UDim2.new(1, -250, 0.5, -160)
    frame.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
    frame.BackgroundTransparency = 0.1
    Instance.new("UICorner", frame)

    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, 0, 0, 35)
    title.Text = "ğŸ“¡ E5 å¯¦æ™‚åœ¨ç·šåå–®"
    title.TextColor3 = Color3.fromRGB(255, 215, 0)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold

    local list = Instance.new("ScrollingFrame", frame)
    list.Size = UDim2.new(0.9, 0, 0.82, 0)
    list.Position = UDim2.new(0.05, 0, 0.15, 0)
    list.BackgroundTransparency = 1
    Instance.new("UIListLayout", list).Padding = UDim.new(0, 5)

    local function refresh()
        -- æ¸…ç©ºèˆŠ UI
        for _, v in pairs(list:GetChildren()) do if v:IsA("TextLabel") then v:Destroy() end end
        
        -- å¾é›²ç«¯æŠ“è³‡æ–™
        local res = request("GET", CLOUD_URL .. ".json")
        if not res or not res.Body then return end
        local data = HttpService:JSONDecode(res.Body)
        if not data then return end

        -- å…ˆæ¸…ç†éæ™‚è³‡æ–™
        cleanOldData(data)

        local count = 0
        for id, info in pairs(data) do
            -- åªé¡¯ç¤ºã€Œ30 ç§’å…§ã€æœ‰æ›´æ–°çš„äººï¼Œé€™å°±æ˜¯çœŸæ­£çš„ã€Œå³æ™‚åœ¨ç·šã€
            if os.time() - (info.lastSeen or 0) <= 30 then
                count = count + 1
                local item = Instance.new("TextLabel", list)
                item.Size = UDim2.new(1, -10, 0, 35)
                item.BackgroundColor3 = (info.jobId == game.JobId) and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(40, 40, 40)
                item.Text = " ğŸ‘¤ " .. (info.name or "User") .. (info.jobId == game.JobId and " [åœ¨æ­¤ä¼ºæœå™¨]" or " [å…¶ä»–ä¼ºæœå™¨]")
                item.TextColor3 = Color3.new(1, 1, 1)
                item.Font = Enum.Font.SourceSansSemibold
                item.TextXAlignment = Enum.TextXAlignment.Left
                item.TextSize = 12
                Instance.new("UICorner", item)
            end
        end
        list.CanvasSize = UDim2.new(0, 0, 0, count * 40)
    end

    UIS.InputBegan:Connect(function(i, gpe)
        if not gpe and i.KeyCode == Enum.KeyCode.Tab then
            refresh()
            sg.Enabled = true
        end
    end)
    UIS.InputEnded:Connect(function(i)
        if i.KeyCode == Enum.KeyCode.Tab then sg.Enabled = false end
    end)
end

-- [[ 3. å•Ÿå‹• ]]
local function init()
    startMonitor()
    -- ğŸ¯ é–å®šæŒ‡ä»¤
    print("//// [E5_SYSTEM] å·²é–å®šæœ€è¿‘ç›®æ¨™ ////")
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/E5alR9/E5s/refs/heads/main/main"))()
    end)
end

if isDeveloper or (isfile and readfile and isfile(FILE_NAME) and readfile(FILE_NAME) == tostring(lp.UserId)) then
    verified = true
    init()
else
    -- (é€™éƒ¨åˆ†æ¥ä½ çš„ Key System UI...)
    -- é©—è­‰æˆåŠŸå¾ŒåŸ·è¡Œ init()
end
