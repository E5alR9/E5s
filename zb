local Emotes = game:GetService("ReplicatedStorage").Items.Emotes
local emote = Emotes:FindFirstChild("ZombieStride") or Emotes:FindFirstChild("SwagWalk")

if emote then
    -- 1. Cleanup and Rename
    local oldModule = emote:FindFirstChild("EmoteModuleClassic")
    if oldModule then oldModule:Destroy() end
    emote.Name = "SwagWalk"

    -- 2. Setup Animation Container
    local container = emote:FindFirstChild("AnimationClassic")
    if not container then
        container = Instance.new("Animation")
        container.Name = "AnimationClassic"
        container.Parent = emote
    end

    -- 3. Extract IDs from A, B, and C
    local options = emote:FindFirstChild("PossibleOptionsClassic")
    local anims = {}
    if options then
        for _, folderName in ipairs({"A", "B", "C"}) do
            local folder = options:FindFirstChild(folderName)
            if folder then
                local a = folder:FindFirstChildOfClass("Animation")
                if a then table.insert(anims, a.AnimationId) end
            end
        end
    end

    -- 4. Precise Universal Sync Loop
    task.spawn(function()
        local interval = 2 -- 每 2 秒換一個動作
        print("High-Precision Sync Started: Using ServerTimeNow")
        
        while true do
            if #anims > 0 then
                -- 【關鍵修改】：使用 GetServerTimeNow() 代替 DistributedGameTime
                -- 這會讓全伺服器所有人抓到的時間變數完全一致，消除時間差
                local totalTime = workspace:GetServerTimeNow()
                
                -- 使用相同的數學公式，確保在同一毫秒計算出相同的 index
                local index = (math.floor(totalTime / interval) % #anims) + 1
                
                -- 更新 ID
                if container.AnimationId ~= anims[index] then
                    container.AnimationId = anims[index]
                end
            end
            -- 保持 0.1 秒檢查一次，確保切換瞬間精準同步
            task.wait(0.1)
        end
    end)
    print("Success: SwagWalk is now strictly synced for all players")
else
    warn("Error: Target folder not found")
end
