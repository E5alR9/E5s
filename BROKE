-- [[ 全域變數初始化 ]]
_G.bhop = false

local p = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

-- [[ 核心循環：處理 Bhop ]]
RS.Heartbeat:Connect(function()
    local c = p.Character
    local hum = c and c:FindFirstChildOfClass("Humanoid")

    -- 只有當 _G.bhop 為 true 且人不在空中時起跳
    if _G.bhop and hum then
        if hum.FloorMaterial ~= Enum.Material.Air then
            hum:ChangeState(3) -- 使用你指定的 ChangeState(3)
        end
    end
end)

-- [[ 手機跳躍按鈕精準偵測 ]]
UIS.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        -- 取得手機官方跳躍按鈕
        local touchGui = p:FindFirstChild("PlayerGui") and p.PlayerGui:FindFirstChild("TouchGui")
        local jumpBtn = touchGui and touchGui:FindFirstChild("JumpButton", true)
        
        if jumpBtn and jumpBtn.Visible then
            local pos = input.Position
            local absPos = jumpBtn.AbsolutePosition
            local absSize = jumpBtn.AbsoluteSize
            
            -- 判斷手指是否按在按鈕範圍內
            if pos.X >= absPos.X and pos.X <= (absPos.X + absSize.X) and
               pos.Y >= absPos.Y and pos.Y <= (absPos.Y + absSize.Y) then
                _G.bhop = true
            end
        end
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        -- 只要手指離開螢幕，就停止 Bhop
        _G.bhop = false
    end
end)
