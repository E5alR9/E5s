-- [[ 全域變數初始化 ]]
_G.bhop = false

local p = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")

-- [[ 獲取並綁定 UI 事件 ]]
local function bindJumpButton()
    local touchGui = p:WaitForChild("PlayerGui"):WaitForChild("TouchGui", 10)
    local jumpBtn = touchGui and touchGui:WaitForChild("JumpButton", 10)

    if jumpBtn then
        -- 當手指壓下按鈕
        jumpBtn.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.Touch then
                _G.bhop = true
            end
        end)

        -- 當手指離開按鈕
        jumpBtn.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.Touch then
                _G.bhop = false
            end
        end)
    end
end

-- 執行綁定
bindJumpButton()

-- 如果角色重生，UI 會重置，所以要重新綁定
p.CharacterAdded:Connect(function()
    task.wait(1) -- 等待 UI 加載
    bindJumpButton()
end)

-- [[ 核心 Bhop 物理循環 ]]
RS.Heartbeat:Connect(function()
    local c = p.Character
    local hum = c and c:FindFirstChildOfClass("Humanoid")

    if _G.bhop and hum then
        -- 判斷：在地上 或 撞牆中的墜落狀態
        if hum.FloorMaterial ~= Enum.Material.Air or hum:GetState() == Enum.HumanoidStateType.Freefall then
            hum:ChangeState(3) -- 強制起跳
        end
    end
end)
