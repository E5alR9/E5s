local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- [[ 1. 開關邏輯：檢查是否已經執行過 ]]
local existingGui = player.PlayerGui:FindFirstChild("AutoJumpOverlay")

if existingGui then
    -- 如果 UI 已經存在，表示使用者想「關閉」，直接刪除並停止腳本
    existingGui:Destroy()
    print("Auto Jump: OFF")
    return -- 結束腳本執行
else
    print("Auto Jump: ON")
end

-- [[ 2. 初始化變數與 UI ]]
local isHolding = false

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoJumpOverlay"
screenGui.ResetOnSpawn = false 
screenGui.Parent = player:WaitForChild("PlayerGui")

local jumpButton = Instance.new("TextButton")
jumpButton.Name = "JumpButton"
jumpButton.BackgroundTransparency = 1 
jumpButton.TextTransparency = 1        
jumpButton.Text = "AUTO JUMP"
jumpButton.Parent = screenGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(1, 0)
uiCorner.Parent = jumpButton

-- [[ 3. 定位邏輯 ]]
local function syncPosition()
    if not screenGui.Parent then return end -- 如果 UI 被刪除了就停止同步
    local touchGui = player.PlayerGui:FindFirstChild("TouchGui")
    local realBtn = touchGui and touchGui:FindFirstChild("JumpButton", true)
    
    if realBtn then
        jumpButton.Position = UDim2.new(0, realBtn.AbsolutePosition.X, 0, realBtn.AbsolutePosition.Y)
        jumpButton.Size = UDim2.new(0, realBtn.AbsoluteSize.X, 0, realBtn.AbsoluteSize.Y)
    else
        jumpButton.Size = UDim2.new(0, 80, 0, 80)
        jumpButton.Position = UDim2.new(1, -120, 1, -90)
    end
end

-- 使用 task.spawn 保持位置同步
task.spawn(function()
    while screenGui.Parent do
        syncPosition()
        task.wait(1)
    end
end)

-- [[ 4. 偵測輸入 ]]
jumpButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isHolding = true
        jumpButton.BackgroundTransparency = 0.8
        jumpButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    end
end)

jumpButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isHolding = false
        jumpButton.BackgroundTransparency = 1
    end
end)

-- [[ 5. 核心連跳邏輯 ]]
-- 這裡加一個變數儲存連線，以便 UI 刪除時能斷開連線節省效能
local connection
connection = RunService.Heartbeat:Connect(function()
    if not screenGui.Parent then 
        connection:Disconnect() -- 如果 UI 消失了，自動斷開連線
        return 
    end

    if isHolding then
        local character = player.Character
        if character then
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid.Health > 0 then
                humanoid.Jump = true
                
                if humanoid:GetState() == Enum.HumanoidStateType.Landed or humanoid.FloorMaterial ~= Enum.Material.Air then
                    humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                end
            end
        end
    end
end)
