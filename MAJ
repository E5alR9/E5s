-- [[ 全域變數初始化 ]]
_G.bhop = false

local p = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local activeJumpTouch = nil -- 專門追蹤按在跳躍鍵上的手指

-- [[ 綁定函數 ]]
local function setupJumpDetection()
	local touchGui = p:WaitForChild("PlayerGui"):WaitForChild("TouchGui", 10)
	local jumpBtn = touchGui and touchGui:WaitForChild("JumpButton", 10)

	if jumpBtn then
		-- 當手指點下跳躍鍵
		jumpBtn.InputBegan:Connect(function(input)
			if input.UserInputType == Enum.UserInputType.Touch then
				activeJumpTouch = input
				_G.bhop = true
			end
		end)

		-- 當手指離開（無論是滑開還是抬起）
		jumpBtn.InputEnded:Connect(function(input)
			if input == activeJumpTouch then
				activeJumpTouch = nil
				_G.bhop = false
			end
		end)
	end
end

setupJumpDetection()
p.CharacterAdded:Connect(function() task.wait(1) setupJumpDetection() end)

-- [[ 核心循環 ]]
RS.Heartbeat:Connect(function()
	local char = p.Character
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	local root = char and char:FindFirstChild("HumanoidRootPart")

	if _G.bhop and hum and root then
		-- 只有在接近地面或撞牆時才觸發，防止在天上飛
		local state = hum:GetState()
		local isOnGround = hum.FloorMaterial ~= Enum.Material.Air
		
		if isOnGround or state == Enum.HumanoidStateType.Freefall or state == Enum.HumanoidStateType.Landed then
			-- 檢查 Y 速度，避免在空中連續疊加力量
			if root.AssemblyLinearVelocity.Y < 1 then
				hum:ChangeState(3)
				root.AssemblyLinearVelocity = Vector3.new(root.AssemblyLinearVelocity.X, 50, root.AssemblyLinearVelocity.Z)
			end
		end
	end
end)
