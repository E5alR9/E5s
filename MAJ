-- [[ 全域變數初始化 ]]
_G.bhop = false

local p = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

-- 取得跳躍按鈕
local function getJumpButton()
    local touchGui = p:FindFirstChild("PlayerGui") and p.PlayerGui:FindFirstChild("TouchGui")
    return touchGui and touchGui:FindFirstChild("JumpButton", true)
end

-- [[ 核心循環 ]]
RS.Heartbeat:Connect(function()
    local char = p.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    local jumpBtn = getJumpButton()

    if hum and jumpBtn and jumpBtn.Visible then
        local isTouching = false
        
        -- 遍歷目前螢幕上所有觸碰點，檢查是否有任何一點在跳躍鈕內
        local touches = UIS:GetTouches()
        for _, touch in ipairs(touches) do
            local pos = touch.Position
            local absPos = jumpBtn.AbsolutePosition
            local absSize = jumpBtn.AbsoluteSize
            
            if pos.X >= absPos.X and pos.X <= absPos.X + absSize.X and
               pos.Y >= absPos.Y and pos.Y <= absPos.Y + absSize.Y then
                isTouching = true
                break
            end
        end
        
        _G.bhop = isTouching

        -- [[ 執行跳躍邏輯 ]]
        if _G.bhop then
            -- 如果人在地上，強制觸發
            if hum.FloorMaterial ~= Enum.Material.Air then
                -- 核心：先設為 false 再設為 true，強制刷新遊戲的偵測器
                hum.Jump = false
                task.wait() -- 極微小延遲確保系統偵測到狀態改變
                hum.Jump = true
                hum:ChangeState(3)
            end
        end
    end
end)
