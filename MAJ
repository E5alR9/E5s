-- [[ 全域變數初始化 ]]
_G.bhop = false

local p = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")

-- [[ 綁定 UI 事件 ]]
local function setupBhop()
    local touchGui = p:WaitForChild("PlayerGui"):WaitForChild("TouchGui", 10)
    local jumpBtn = touchGui and touchGui:WaitForChild("JumpButton", 10)

    if jumpBtn then
        -- 使用底層事件判定按下
        jumpBtn.MouseButton1Down:Connect(function()
            _G.bhop = true
        end)

        -- 使用底層事件判定放開
        jumpBtn.MouseButton1Up:Connect(function()
            _G.bhop = false
        end)
        
        -- 額外保險：如果手指滑出按鈕範圍也要停止
        jumpBtn.MouseLeave:Connect(function()
            _G.bhop = false
        end)
    end
end

setupBhop()
p.CharacterAdded:Connect(function() task.wait(1) setupBhop() end)

-- [[ 核心循環 ]]
RS.Heartbeat:Connect(function()
    local char = p.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")

    if _G.bhop and hum then
        -- 判斷：人在地上時才執行
        if hum.FloorMaterial ~= Enum.Material.Air then
            -- 暴力法：先關再開，強制刷新遊戲的跳躍偵測
            hum.Jump = false
            hum.Jump = true
            hum:ChangeState(3)
        end
    end
end)
